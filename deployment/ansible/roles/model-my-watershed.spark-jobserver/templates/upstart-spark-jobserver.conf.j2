description "Spark Job Server"

{% if ['development', 'test'] | some_are_in(group_names) -%}
start on (vagrant-mounted and started docker)
{% else -%}
start on (filesystem and started docker)
{% endif -%}
stop on stopping docker

kill timeout 20
kill signal CONT
respawn

pre-start script
  /usr/bin/docker kill spark-jobserver || true
  /usr/bin/docker rm spark-jobserver || true
end script

exec /usr/bin/docker run \
  --name spark-jobserver \
  --publish 8090:8090 \
  {% if ['development', 'test'] | some_are_in(group_names) -%}
  --volume /home/vagrant/.aws:/root/.aws \
  {% endif -%}
  --volume {{ sjs_home }}/spark-jobserver.conf:{{ sjs_home }}/spark-jobserver.conf \
  --volume {{ sjs_jars_dir }}:{{ sjs_jars_dir }} \
  --volume {{ sjs_filedao_dir }}:{{ sjs_filedao_dir }} \
  {% for k,v in app_config.items() -%}
  --env {{ k }}={{ v }} \
  {% endfor -%}
  --log-driver syslog \
  quay.io/azavea/spark-jobserver:latest --driver-memory 512M

post-stop script
  /usr/bin/docker kill spark-jobserver
  /usr/bin/docker rm spark-jobserver
end script
